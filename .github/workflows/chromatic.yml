# .github/workflows/chromatic.yml

name: 'Chromatic Visual Regression Testing'

# main ë¸Œëœì¹˜ì— push ë˜ê±°ë‚˜, main ë¸Œëœì¹˜ë¡œ í–¥í•˜ëŠ” PRì´ ì—´ë¦´ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  chromatic-deployment:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # fetch-depth: 0ì€ Chromaticì´ ë¸Œëœì¹˜ ê°„ì˜ ë³€ê²½ ì‚¬í•­ì„ ì •í™•íˆ ë¹„êµí•˜ê¸° ìœ„í•´
      # ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í•˜ëŠ” ì¤‘ìš”í•œ ì˜µì…˜ì…ë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. PNPM ì„¤ì¹˜
      # package.jsonì— ëª…ì‹œëœ pnpm ë²„ì „ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - name: Set up PNPM
        uses: pnpm/action-setup@v4

      # 3. Node.js ì„¤ì¹˜
      # í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” Node.js ë²„ì „ì„ ì§€ì •í•©ë‹ˆë‹¤.
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm' # pnpm ì˜ì¡´ì„± ìºì‹± í™œì„±í™”

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      # pnpm installì„ ì‹¤í–‰í•˜ì—¬ ëª¨ë“  ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install dependencies
        run: pnpm install

        # âœ… [ë””ë²„ê¹…] ì „ì²´ íŒŒì¼ êµ¬ì¡° í™•ì¸ (node_modules, .git ì œì™¸)
      - name: ğŸ“‚ Debug - Show File Structure
        run: |
          # 1. tree ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜
          sudo apt-get update && sudo apt-get install -y tree

          echo "=========================================="
          echo "ğŸ“ PROJECT ROOT TREE (node_modules ì œì™¸)"
          echo "=========================================="
          # -I ì˜µì…˜ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ í´ë” ì œì™¸í•˜ê³  ì „ì²´ êµ¬ì¡° ì¶œë ¥
          tree -I 'node_modules|.git|dist|.nx'

          echo " "
          echo "=========================================="
          echo "ğŸ“ APPS/CORE DETAILED CHECK"
          echo "=========================================="
          # ë¬¸ì œê°€ ë˜ëŠ” apps/core ë‚´ë¶€ëŠ” ìˆ¨ê¹€ íŒŒì¼(.ìœ¼ë¡œ ì‹œì‘)ê¹Œì§€ í¬í•¨í•´ì„œ ìì„¸íˆ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
          ls -Rla apps/core

      # 5. Storybook ë¹Œë“œ (ë‹¨ê³„ ë¶„ë¦¬)
      # ì´ ë‹¨ê³„ì—ì„œ Storybook ì •ì  íŒŒì¼ì„ 'dist/storybook/core' ê²½ë¡œì— ìƒì„±í•©ë‹ˆë‹¤.
      - name: Build Storybook
        run: pnpm nx run core:build-storybook --no-cloud --stats-json

      # âœ… [ë””ë²„ê¹…ìš©] ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ë‹¨ê³„ ì¶”ê°€
      - name: Check build output
        run: |
          echo "--- Listing files in dist/storybook/core ---"
          ls -R dist/storybook/core

      # 6. Chromaticì— ë°°í¬ (action ëŒ€ì‹  CLI ì§ì ‘ ì‹¤í–‰)
      - name: Publish to Chromatic
        run: |
          pnpm chromatic --project-token=${{ secrets.CHROMATIC_PROJECT_TOKEN }} --storybook-build-dir=dist/storybook/core --exit-zero-on-changes
